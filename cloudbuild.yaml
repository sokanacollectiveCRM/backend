# Cloud Build: builds and pushes to Artifact Registry (NOT gcr.io).
# The trigger MUST use this file: Configuration type = "Cloud Build configuration file",
# Location = "cloudbuild.yaml". If the trigger uses Autodetect/Dockerfile/Buildpack
# instead, Cloud Build uses a default image name (gcr.io/...) and you get push errors.
steps:
  - name: gcr.io/k8s-skaffold/pack
    args:
      - build
      - us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-source-deploy/backend/sokana-private-api:$COMMIT_SHA
      - --builder
      - gcr.io/buildpacks/builder:v1
      - --trust-builder
      - --network=cloudbuild
      - --path
      - .
    env:
      - GOOGLE_ENTRYPOINT=node dist/cloudrun.js

  - name: gcr.io/cloud-builders/docker
    args:
      - push
      - us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-source-deploy/backend/sokana-private-api:$COMMIT_SHA

  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    entrypoint: gcloud
    args:
      - run
      - services
      - update
      - sokana-private-api
      - --image=us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-source-deploy/backend/sokana-private-api:$COMMIT_SHA
      - --region=us-central1
